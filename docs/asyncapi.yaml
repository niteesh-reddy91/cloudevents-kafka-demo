# AsyncAPI specification for CloudEvent Envelope with PersonWorker data
asyncapi: 3.0.0

# Basic information about your API
info:
  title: CloudEvent PersonWorker API
  version: 2.0.0
  description: |
    Event-driven API using Kafka with CloudEvents and Avro serialization for PersonWorker domain.
    Uses CloudEvent structure with comprehensive validation rules and Schema Registry integration.
    Supports PersonWorker lifecycle events (Created, Updated, Deleted) with custom validation logic.
  contact:
    name: Data Platform Team
    email: dataplatform@example.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

# Default content type for messages (Avro binary)
defaultContentType: application/octet-stream

# Server configurations - your Kafka and Schema Registry setup
servers:
  kafka:
    host: localhost:9092
    protocol: kafka
    description: Local Kafka broker running on Docker Desktop
    bindings:
      kafka:
        schemaRegistryUrl: http://localhost:8081
        schemaRegistryVendor: confluent
  
  schema-registry:
    host: localhost:8081
    protocol: http
    description: Confluent Schema Registry for Avro schema management

# Channels represent your Kafka topics
channels:
  person-worker-events:
    address: person-worker-events
    description: |
      Main topic for PersonWorker lifecycle events. Handles creation, updates, and deletion 
      of PersonWorker entities using CloudEvent structure with Avro serialization.
    messages:
      personWorkerEvent:
        $ref: '#/components/messages/personWorkerEvent'
    bindings:
      kafka:
        partitions: 3
        replicas: 1
        topicConfiguration:
          cleanup.policy: ["delete"]
          retention.ms: 604800000

  order-events:
    address: order-events
    description: Topic for order-related events (configured in validation rules)
    
  inventory-events:
    address: inventory-events
    description: Topic for inventory-related events (configured in validation rules)

# Operations define what your services do
operations:
  # Producer Service Contracts
  publishPersonWorkerCreated:
    action: send
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Producer publishes PersonWorker creation events
    description: |
      **Service**: App.java (Producer Service)
      **Business Context**: When a new PersonWorker is onboarded to the system
      
      This operation is triggered when:
      - A new employee joins the company
      - HR system creates a new worker profile
      - User registration process completes
      
      **Data Flow**:
      1. Producer validates PersonWorker data against comprehensive Avro schema validation rules
      2. Creates CloudEvent envelope with type "com.example.person.created"
      3. Serializes using Avro built-in serialization (not Jackson)
      4. Auto-registers/updates schema in Schema Registry
      5. Publishes to person-worker-events for downstream processing
      
      **SLA**: Messages published within 100ms of data validation
      **Error Handling**: Invalid data is rejected before publishing
    bindings:
      kafka:
        clientId: 
          type: string
          const: "cloudevent-producer"
        groupId:
          type: string  
          const: "producer-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventPublisher'

  publishPersonWorkerUpdated:
    action: send
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Producer publishes PersonWorker update events
    description: |
      **Service**: App.java (Producer Service)
      **Business Context**: When existing PersonWorker information is modified
      
      This operation is triggered when:
      - Employee information is updated (contact details, status, etc.)
      - HR system modifies worker profile
      - Self-service profile updates by employees
      
      **Business Rules**:
      - Only active employees can be updated
      - Age modifications require manager approval
      - Email changes trigger verification workflow
      
      **Downstream Impact**: 
      - Payroll systems need to update records
      - Access control systems may need permission updates
      - Notification service sends update confirmations
    bindings:
      kafka:
        clientId: 
          type: string
          const: "cloudevent-producer"
        groupId:
          type: string  
          const: "producer-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventPublisher'

  publishPersonWorkerDeleted:
    action: send
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Producer publishes PersonWorker deletion events
    description: |
      **Service**: App.java (Producer Service)
      **Business Context**: When a PersonWorker is removed from the system
      
      This operation is triggered when:
      - Employee termination or resignation
      - Contract expiration for temporary workers
      - Data privacy compliance (GDPR right to be forgotten)
      
      **Business Rules**:
      - Only HR managers can trigger deletion events
      - Final payroll must be processed before deletion
      - Archive certain data before full deletion
      
      **Compliance**: Ensures audit trail for terminated employees
    bindings:
      kafka:
        clientId: 
          type: string
          const: "cloudevent-producer"
        groupId:
          type: string  
          const: "producer-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventPublisher'

  # Consumer Service Contracts
  processPersonWorkerEvents:
    action: receive
    channel:
      $ref: '#/channels/person-worker-events'
    summary: HR System processes PersonWorker lifecycle events
    description: |
      **Service**: HR Management System (Consumer)
      **Business Context**: Maintains master employee records and triggers HR workflows
      
      **Processing Logic**:
      - Created: Initiates onboarding workflow, creates employee ID, sends welcome email
      - Updated: Updates master records, validates changes, triggers dependent system updates
      - Deleted: Archives employee data, terminates access, updates payroll systems
      
      **Validation**: Real-time validation using Schema Registry CloudEvent schema
      **SLA**: Process events within 30 seconds
      **Error Handling**: Dead letter queue for processing and validation failures
      **Idempotency**: Uses CloudEvent ID to prevent duplicate processing
    bindings:
      kafka:
        clientId:
          type: string
          const: "hr-system-consumer"
        groupId:
          type: string
          const: "hr-processing-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventConsumer'

  syncPayrollSystem:
    action: receive
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Payroll System syncs employee data
    description: |
      **Service**: Payroll Processing System (Consumer)
      **Business Context**: Maintains payroll records in sync with employee changes
      
      **Processing Logic**:
      - Created: Sets up new employee in payroll system with default salary structure
      - Updated: Updates employee details, recalculates benefits if age/status changed
      - Deleted: Processes final payroll, generates termination reports
      
      **Business Rules**:
      - Only processes events for employees with status 'active'
      - Age changes may affect benefits calculation
      - Status changes from 'active' to 'inactive' trigger special handling
      
      **Integration**: Updates external payroll vendor systems via API
    bindings:
      kafka:
        clientId:
          type: string
          const: "payroll-system-consumer"
        groupId:
          type: string
          const: "payroll-sync-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventConsumer'

  updateAccessControl:
    action: receive
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Access Control System manages employee permissions
    description: |
      **Service**: Identity & Access Management System (Consumer)
      **Business Context**: Manages employee access rights and security permissions
      
      **Processing Logic**:
      - Created: Creates user accounts, assigns default permissions based on role
      - Updated: Updates user profiles, adjusts permissions if status changed
      - Deleted: Disables accounts immediately, revokes all access permissions
      
      **Security Requirements**:
      - Deleted events are processed with highest priority (within 5 seconds)
      - Status changes to 'inactive' immediately suspend access
      - All changes are logged for security auditing
      
      **Downstream Systems**: Active Directory, VPN access, building access cards
    bindings:
      kafka:
        clientId:
          type: string
          const: "access-control-consumer"
        groupId:
          type: string
          const: "access-management-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventConsumer'

  sendNotifications:
    action: receive
    channel:
      $ref: '#/channels/person-worker-events'
    summary: Notification Service sends employee communication
    description: |
      **Service**: Notification & Communication System (Consumer)
      **Business Context**: Sends appropriate notifications for employee lifecycle events
      
      **Processing Logic**:
      - Created: Sends welcome email, onboarding checklist, manager notifications
      - Updated: Sends confirmation emails for profile changes, alerts for critical updates
      - Deleted: Sends farewell communications, final document delivery
      
      **Business Rules**:
      - Only sends external communications for employees with valid email addresses
      - Manager notifications required for all employee changes
      - Sensitive updates (salary, status) have restricted notification lists
      
      **Channels**: Email, SMS, Slack notifications, mobile app push notifications
    bindings:
      kafka:
        clientId:
          type: string
          const: "notification-service-consumer"
        groupId:
          type: string
          const: "notification-delivery-group"
    messages:
      - $ref: '#/channels/person-worker-events/messages/personWorkerEvent'
    traits:
      - $ref: '#/components/operationTraits/cloudEventConsumer'

# Reusable components
components:
  # Message definitions
  messages:
    personWorkerEvent:
      name: PersonWorkerEvent
      title: PersonWorker Lifecycle Event
      summary: CloudEvent envelope containing PersonWorker data
      description: |
        A CloudEvent envelope containing PersonWorker lifecycle data (Created, Updated, Deleted).
        Uses comprehensive validation rules defined in Avro schema for data integrity and follows CloudEvents specification.
        
        The envelope contains:
        - CloudEvent metadata (id, source, type, time, sourceplatform, sourceplatformid, clientid)
        - PersonWorker data with extensive validation rules including:
          * Required field validation (gupi, firstName, lastName, birthDate, sex)
          * Pattern validation for names and identifiers
          * Enumerated values for sex, maritalStatus, prefix, suffix
          * Date format validation
          * String length constraints
      contentType: application/octet-stream
      headers:
        $ref: '#/components/schemas/kafkaHeaders'
      payload:
        schemaFormat: 'application/vnd.apache.avro;version=1.9.0'
        schema:
          $ref: '../src/main/avro/combined.avsc#/0'

  # Schema definitions
  schemas:
    kafkaHeaders:
      type: object
      description: Standard Kafka message headers
      properties:
        content-type:
          type: string
          description: Content type of the message
          example: "application/octet-stream"

  # Operation traits for reusable patterns
  operationTraits:
    cloudEventPublisher:
      description: |
        Common traits for all CloudEvent publishing operations.
        
        **Producer Configuration**:
        - Uses idempotent producer settings
        - Retry configuration for reliability
        - Compression enabled for efficiency
        - All acknowledgments required for durability
        - Avro schema validation rules enforced before publishing
      summary: CloudEvent publisher operation pattern
    
    cloudEventConsumer:
      description: |
        Common traits for all CloudEvent consuming operations.
        
        **Consumer Configuration**:
        - Reads from earliest offset for complete processing
        - Manual commit for exactly-once processing
        - Appropriate session timeout for reliability
        - Batched processing for efficiency
        - Schema Registry validation on message consumption
        - Dead letter queue handling for validation failures
      summary: CloudEvent consumer operation pattern